<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Binary Tree Plan Game</title>

<style>
    body {
        margin: 0;
        background: #020617;
        color: white;
        font-family: Arial, sans-serif;
        overflow: hidden;
    }

    #controls {
        padding: 12px;
        background: #020617;
        border-bottom: 1px solid #334155;
        display: flex;
        gap: 10px;
    }

    button {
        background: #1e293b;
        color: white;
        border: 1px solid #334155;
        padding: 6px 14px;
        border-radius: 6px;
        cursor: pointer;
    }

    button:hover {
        background: #334155;
    }

    svg {
        width: 100vw;
        height: calc(100vh - 60px);
    }

    .node circle {
        stroke-width: 2;
    }

    .node.active circle {
        fill: #14532d;
        stroke: #22c55e;
    }

    .node.inactive circle {
        fill: #020617;
        stroke: #64748b;
    }

    .selected circle {
        stroke: #facc15 !important;
        stroke-width: 3;
    }

    text {
        fill: white;
        text-anchor: middle;
        pointer-events: none;
        font-size: 11px;
    }

    line {
        stroke: #475569;
        stroke-width: 2;
    }
</style>
</head>

<body>

<div id="controls">
    <button onclick="createRoot()">Create Root</button>
    <button onclick="applyPlan('Single')">Single</button>
    <button onclick="applyPlan('Triple')">Triple</button>
    <button onclick="applyPlan('VIP')">VIP</button>
</div>

<svg id="game"></svg>

<script>
/* ===================== DATA ===================== */
class Node {
    constructor(name, parent = null) {
        this.name = name;
        this.parent = parent;
        this.left = null;
        this.right = null;
        this.isActive = false;
        this.LeftCount = 0;
        this.RightCount = 0;
        this.points = 0;
        this.x = 0;
        this.y = 0;
    }
}

let root = null;
let selectedNode = null;
let nodeId = 1;
const svg = document.getElementById("game");

/* ===================== CALCULATION (UNCHANGED LOGIC) ===================== */
function CalculateNodes(node) {
    if (!node) return 0;

    // Calculate children first (post-order traversal)
    const leftPoints = node.left ? CalculateNodes(node.left) : 0;
    const rightPoints = node.right ? CalculateNodes(node.right) : 0;

    // Base rule: 1 point only if BOTH direct children are active
    const basePoint =
        node.left?.isActive &&
        node.right?.isActive && 
        node.isActive
            ? 1
            : 0;

    // Inherit points ONLY from active direct children
    const inheritedPoints =
        (node.left?.isActive ? leftPoints : 0) +
        (node.right?.isActive ? rightPoints : 0);

    // Final points
    node.points = node.isActive ? basePoint + inheritedPoints : 0;

    // âœ… CORRECT COUNTS: total active nodes in left and right SUBTREES
    node.LeftCount = countActiveSubtree(node.left);
    node.RightCount = countActiveSubtree(node.right);

    return node.points;
}

// Helper: count all active nodes in a subtree (including root of subtree)
function countActiveSubtree(node) {
    if (!node) return 0;
    return (node.isActive ? 1 : 0) +
           countActiveSubtree(node.left) +
           countActiveSubtree(node.right);
}


/* ===================== GAME LOGIC ===================== */
function createRoot() {
    root = new Node("Root");
    selectedNode = root;
    redraw();
}

function applyPlan(plan) {
    if (!selectedNode) return;
    generatePlanSubtree(selectedNode, plan);
    redraw();
}

function generatePlanSubtree(baseNode, plan) {
    if (baseNode.left || baseNode.right) return;

    const L = new Node("N" + nodeId++, baseNode);
    const R = new Node("N" + nodeId++, baseNode);
    baseNode.left = L;
    baseNode.right = R;

    const LL = new Node("N" + nodeId++, L);
    const LR = new Node("N" + nodeId++, L);
    L.left = LL;
    L.right = LR;

    const RL = new Node("N" + nodeId++, R);
    const RR = new Node("N" + nodeId++, R);
    R.left = RL;
    R.right = RR;

    const nodes = [baseNode, L, R, LL, LR, RL, RR];
    nodes.forEach(n => n.isActive = false);

    if (plan === "Single") {
        baseNode.isActive = true;
    }
    if (plan === "Triple") {
        baseNode.isActive = true;
        L.isActive = true;
        R.isActive = true;
    }
    if (plan === "VIP") {
        nodes.forEach(n => n.isActive = true);
    }
}

/* ===================== LAYOUT ===================== */
function layoutTree(node, depth = 0, minX = 0, maxX = svg.clientWidth) {
    if (!node) return;

    node.x = (minX + maxX) / 2;
    node.y = depth * 110 + 70;

    layoutTree(node.left, depth + 1, minX, node.x);
    layoutTree(node.right, depth + 1, node.x, maxX);
}

/* ===================== RENDER ===================== */
function redraw() {
    svg.innerHTML = "";
    if (!root) return;

    CalculateNodes(root);
    layoutTree(root);
    drawLinks(root);
    drawNodes(root);
}

function drawLinks(node) {
    if (!node) return;

    if (node.left) {
        drawLine(node, node.left);
        drawLinks(node.left);
    }
    if (node.right) {
        drawLine(node, node.right);
        drawLinks(node.right);
    }
}

function drawLine(a, b) {
    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", a.x);
    line.setAttribute("y1", a.y);
    line.setAttribute("x2", b.x);
    line.setAttribute("y2", b.y);
    svg.appendChild(line);
}

function drawNodes(node) {
    if (!node) return;

    const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    g.classList.add("node", node.isActive ? "active" : "inactive");
    if (node === selectedNode) g.classList.add("selected");

    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    circle.setAttribute("cx", node.x);
    circle.setAttribute("cy", node.y);
    circle.setAttribute("r", 32);

    const t1 = document.createElementNS("http://www.w3.org/2000/svg", "text");
    t1.setAttribute("x", node.x);
    t1.setAttribute("y", node.y - 8);
    t1.textContent = `P: ${node.points}`;

    const t2 = document.createElementNS("http://www.w3.org/2000/svg", "text");
    t2.setAttribute("x", node.x);
    t2.setAttribute("y", node.y + 10);
    t2.textContent = `L:${node.LeftCount} | R:${node.RightCount}`;

    g.appendChild(circle);
    g.appendChild(t1);
    g.appendChild(t2);

    g.onclick = () => {
        selectedNode = node;
        redraw();
    };

    svg.appendChild(g);
    drawNodes(node.left);
    drawNodes(node.right);
}
</script>

</body>
</html>
